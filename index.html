<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Photo Studio</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Material Web Components -->
  <script type="module">
    import '@material/web/button/filled-button.js';
  </script>
  <style>
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .timer {
      font-size: 4rem;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
    }
    md-filled-button {
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    md-filled-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
      filter: brightness(110%);
    }
    md-filled-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-800 min-h-screen flex flex-col items-center p-6">
  <h1 class="text-4xl font-bold mb-8 text-white">Photo Studio</h1>
  
  <div class="relative">
    <video id="video" width="640" height="480" autoplay class="rounded-xl shadow-lg"></video>
    <div id="timer" class="timer">3</div>
  </div>
  
  <div class="mt-6 flex gap-4">
    <md-filled-button id="captureBtn" class="!bg-blue-600">Take 4 Photos</md-filled-button>
    <md-filled-button id="printBtn" class="!bg-green-600">Print All</md-filled-button>
    <md-filled-button id="resetBtn" class="!bg-red-600">Reset</md-filled-button>
  </div>
  
  <div class="photo-grid mt-8">
    <canvas id="canvas1" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
    <canvas id="canvas2" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
    <canvas id="canvas3" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
    <canvas id="canvas4" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const timer = document.getElementById('timer');
    const captureBtn = document.getElementById('captureBtn');
    const printBtn = document.getElementById('printBtn');
    const resetBtn = document.getElementById('resetBtn');
    const canvases = [
      document.getElementById('canvas1'),
      document.getElementById('canvas2'),
      document.getElementById('canvas3'),
      document.getElementById('canvas4')
    ];
    const contexts = canvases.map(canvas => canvas.getContext('2d'));
    let currentPhoto = 0;
    let isCapturing = false;

    // Get camera feed with optimal settings
    const cameraConstraints = {
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: 'user'
      }
    };

    async function initializeCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia(cameraConstraints);
        video.srcObject = stream;
        captureBtn.disabled = false;
      } catch (err) {
        console.error('Camera access error:', err);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-red-500 text-center mt-4';
        errorMessage.textContent = 'Camera access denied. Please check your camera permissions.';
        video.parentElement.appendChild(errorMessage);
        captureBtn.disabled = true;
      }
    }

    initializeCamera();

    // Timer function with visual feedback
    function startTimer(callback) {
      let count = 3;
      timer.style.display = 'block';
      timer.textContent = count;
      timer.className = 'timer animate-pulse';
      
      // Flash effect for countdown
      const flash = () => {
        timer.style.transform = 'translate(-50%, -50%) scale(1.2)';
        setTimeout(() => {
          timer.style.transform = 'translate(-50%, -50%) scale(1)';
        }, 200);
      };
      
      flash();
      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          timer.textContent = count;
          flash();
        } else {
          clearInterval(interval);
          timer.className = 'timer';
          timer.style.display = 'none';
          // Reset transform
          timer.style.transform = 'translate(-50%, -50%)';
          callback();
        }
      }, 1000);

      // Cleanup function in case capture is interrupted
      return () => {
        clearInterval(interval);
        timer.className = 'timer';
        timer.style.display = 'none';
        timer.style.transform = 'translate(-50%, -50%)';
      };
    }

    // Capture sequence
    async function captureSequence() {
      if (isCapturing || currentPhoto >= 4) return;
      
      isCapturing = true;
      captureBtn.disabled = true;
      printBtn.disabled = true;
      
      let cleanupTimer = null;
      
      const capturePhoto = () => {
        // Play capture sound
        const captureSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBkCR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTqL0fPTgjMGHm7A7+OZRA0PVqzn77BdGAg+ltryxnMpBSF6yu7glEILElyx6OyrWBUIQ5zd8sFuJAU3iM/z1oU2Bhxsvv7mlEINDlOq5O+zYBoIPJPY8sp2KwUfdsfv45ZFDBFZr+ftrVoXCECY2/LDcSYFNYXN8diHOQYaa7z85JdGDgxPqOPwtWIdCDqQ1vLNei0FHnHF7+WYRw0PV63l765dGQc9ltnzxXQoBTODy/HaijsHGGi6+uWaSg8LS6Xi8LdlHwg3jdTy0H0vBRxvw+/nmUkODVSs5O+xYBsHOpDY8sd2KgUwgMnx3I09BxZmt/jmoE0QCkij4fC6aCAHNYrS8tOAMQUbbcHu6JtMDwxRqeLwuWMdBzaN1fLLeSsFLn7H8d+PPgcUZLX35KJQEQlGoODwvGohBzKIz/LWhDMFGWu/7eqdTxAKTqPh8LxmIAczi9Py0H4tBS19xvHhkUAIEmGz9+anUxIHQZ3e8L5sJAYwhs3y2IY1BRdovO3snFESCUyh4PC/aSIHMIjQ89OCLwUre8Tx45NCCBBfsfblqVYTBz+b3fDAbCUGLYTL8tuINgUWZrrs7Z5SFAhKn+DwwWwkBi6Gz/PVhDEFKHnC8OWWRAkPXK/15axZFQY8mNvwwm8nBiuByPLdiDgFFWS47O2gVRYISJ3f8MNvJQYshczz2IYzBSZ3wfDnmUYJDVqt9OWuXBcGOpbZ8MRyKAYpf8by34o6BRNituv0pVgXB0Wb3vDFcSYGKoPK89qJOgUXYrXr6ZxLEAdBmN3wzHQpBiZ9xPLhi0AFEWCz6/SmWxkGPpjb8MZ0KQYofsfz3Y0+BRVgsev0qF4ZBj+Y3PDHdyoGJX3E8uKNQQYPXrLq9KleGgY9l9rwynksBiR7xvPgj0MFEl+x6/WrYRsGPZba8Mx6LAYje8Tz4ZFEBg1dsOn1rWMcBjuV2fDNfS4GIXrF8+OSRgYQXK/p9a9lHgY7lNjwzn8vBh96xPPjlEgHDFqv6PawZx8GOZLWpdF/MAYfesPz5ZVKBwpYruj2s2oiBjiS1qnTgjIGHXjC8+eYTAgKVqzn97ZtJAY2kNSm1YQ0Bhx2wfLpmlEJCVOq5vi4cCYGNI3TpteFNgYbdL/y6p1TCwhRqOX4u3MoBjGK0qbYiDgHGXK98euiVgsGT6bk+L53KgYviNCm2os7Bxhwu/HtpVoMBk2k4/i/ei4GLYbPptuOPQcWbrrw7qheDgVKouL4w3wxBiqEzqbdkUAHFW248O+rYRAES6Dh+MZ/MwYngsym35RCBxNruO/wrWUTBEie4PjIgjUGJH/Kpt2WRAkTaLbv8LBpFQNGnN/4zIU3BiJ9yKbemEcJEWa17/CzaxcEQ5rd+M+IOQYgecam4JtKChBjse7xtm4ZA0GY3PjSizwGH3bEpuKdTQoOYK/t8bl0HAM+ldr40o8+Bh10wqbjn1AKDVyu7PK8dx8CPJLYqtWTQQYcc8Cm5aJTCwxZrOvyvXohBDqQ1qrXlUQHGnC+puajVgwKV6rq8sFAJAQ4jdSq2ZhHBxhuvabmpVkNCVSo6fLERCcENYvSqtudSgcWbLum565cDQdRpuny0x0=');
        captureSound.play();
        
        // Flash effect
        const flash = document.createElement('div');
        flash.style.position = 'fixed';
        flash.style.top = '0';
        flash.style.left = '0';
        flash.style.right = '0';
        flash.style.bottom = '0';
        flash.style.backgroundColor = 'white';
        flash.style.opacity = '0';
        flash.style.transition = 'opacity 0.1s';
        document.body.appendChild(flash);
        
        requestAnimationFrame(() => {
          flash.style.opacity = '1';
          setTimeout(() => {
            flash.style.opacity = '0';
            setTimeout(() => flash.remove(), 100);
          }, 50);
        });

        // Capture photo
        contexts[currentPhoto].drawImage(
          video, 
          0, 0, 
          canvases[currentPhoto].width, 
          canvases[currentPhoto].height
        );
        
        currentPhoto++;
        
        if (currentPhoto < 4) {
          cleanupTimer = startTimer(capturePhoto);
        } else {
          isCapturing = false;
          captureBtn.disabled = false;
          printBtn.disabled = false;
        }
      };
      
      cleanupTimer = startTimer(capturePhoto);
      
      // Handle interruption
      resetBtn.onclick = () => {
        if (cleanupTimer) {
          cleanupTimer();
        }
        resetPhotos();
      };
    }

    // Reset all photos
    function resetPhotos() {
      contexts.forEach(ctx => {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      });
      currentPhoto = 0;
      captureBtn.disabled = false;
    }

    // Print all photos
    function printPhotos() {
      // Check if there are photos to print
      const hasPhotos = canvases.some(canvas => {
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        return imageData.data.some(pixel => pixel !== 0);
      });

      if (!hasPhotos) {
        alert('Please take some photos before printing!');
        return;
      }

      // Create a hidden print-only container
      const printContainer = document.createElement('div');
      printContainer.className = 'print-only';
      const currentDate = new Date().toLocaleString();
      
      // Add print-specific styles
      const printStyles = document.createElement('style');
      printStyles.textContent = `
        @media screen {
          .print-only {
            display: none;
          }
        }
        @media print {
          /* Hide the main app interface when printing */
          body > *:not(.print-only) {
            display: none !important;
          }
          .print-only {
            display: block;
            margin: 1cm;
          }
          @page {
            size: A4;
            margin: 0;
          }
        }
        .print-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
          margin-bottom: 20px;
        }
        .photo-container {
          aspect-ratio: 4/3;
          background: white;
          border: 1px solid #eee;
          border-radius: 4px;
          overflow: hidden;
        }
        .photo-container img {
          width: 100%;
          height: 100%;
          object-fit: contain;
        }
        .header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 20px;
          border-bottom: 2px solid #eee;
        }
        .timestamp {
          color: #666;
          font-size: 14px;
          margin-top: 5px;
        }
      `;
      document.head.appendChild(printStyles);
      
      // Create the print layout
      printContainer.innerHTML = `
        <div class="header">
          <h1>Photo Studio Prints</h1>
          <div class="timestamp">Printed on ${currentDate}</div>
        </div>
        <div class="print-grid">
          ${canvases.map((canvas, index) => `
            <div class="photo-container">
              <img src="${canvas.toDataURL('image/jpeg', 0.8)}" alt="Photo ${index + 1}">
            </div>
          `).join('')}
        </div>
      `;
      
      // Add the print container to the document
      document.body.appendChild(printContainer);
      
      // Trigger print and clean up afterward
      window.print();
      
      // Remove the print container and styles after printing
      setTimeout(() => {
        document.body.removeChild(printContainer);
        document.head.removeChild(printStyles);
      }, 1000);
    }

    captureBtn.addEventListener('click', captureSequence);
    printBtn.addEventListener('click', printPhotos);
    resetBtn.addEventListener('click', resetPhotos);
  </script>
</body>
</html>
