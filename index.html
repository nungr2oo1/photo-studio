<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Photo Studio</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Razorpay Script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <!-- Material Web Components -->
  <script type="module">
    import '@material/web/button/filled-button.js';
  </script>
  <!-- QR Code library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    /* Background Pattern */
    .bg-grid-pattern {
      background-image: linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 30px 30px;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .mode-card {
      animation: fadeIn 0.6s ease-out;
    }

    .mode-card:nth-child(2) {
      animation-delay: 0.2s;
    }

    /* Main Grid */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .timer {
      font-size: 4rem;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
    }
    md-filled-button {
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    md-filled-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
      filter: brightness(110%);
    }
    md-filled-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #qrCodeContainer {
      display: none;
      margin-top: 2rem;
      padding: 1rem;
      background: white;
      border-radius: 0.5rem;
      text-align: center;
    }
    #qrCode {
      margin: 1rem auto;
    }
    #downloadLink {
      color: #2563eb;
      text-decoration: underline;
      margin-top: 0.5rem;
      display: block;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 min-h-screen flex flex-col items-center p-6 relative overflow-x-hidden">
  <!-- Background Pattern -->
  <div class="absolute inset-0 bg-grid-pattern opacity-5"></div>
  <!-- Content Container -->
  <div class="relative w-full flex flex-col items-center z-10">
  <div class="flex justify-between items-center w-full max-w-6xl mb-8">
    <h1 class="text-4xl font-bold text-white">Photo Studio</h1>
    <a href="admin.html" id="adminLoginBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
      </svg>
      Admin Login
    </a>
  </div>

  <!-- Mode Selection Screen -->
  <div id="modeSelection" class="flex flex-col items-center justify-center min-h-[calc(100vh-12rem)] bg-gray-900/50 p-8 rounded-2xl backdrop-blur-sm max-w-4xl w-full mx-auto my-auto">
    <h2 class="text-2xl font-semibold mb-8 text-white text-center">Select Your Photo Experience</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
      <div class="mode-card cursor-pointer transform transition-all duration-300 hover:scale-105" onclick="selectMode('normal')">
        <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-8 rounded-xl shadow-lg hover:shadow-2xl border border-blue-500/20">
          <div class="flex flex-col h-full">
            <h3 class="text-2xl font-bold text-white mb-4">Normal Mode</h3>
            <p class="text-blue-100 mb-6">Take standard photo booth pictures with customizable settings.</p>
            <div class="mt-auto flex justify-end">
              <span class="text-white/80 text-sm">₹200 per session</span>
            </div>
          </div>
        </div>
      </div>
      <div class="mode-card cursor-pointer transform transition-all duration-300 hover:scale-105" onclick="selectMode('event')">
        <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-8 rounded-xl shadow-lg hover:shadow-2xl border border-purple-500/20">
          <div class="flex flex-col h-full">
            <h3 class="text-2xl font-bold text-white mb-4">Event Mode</h3>
            <p class="text-purple-100 mb-6">Special features for events with custom branding and layouts.</p>
            <div class="mt-auto flex justify-end">
              <span class="text-white/80 text-sm">Contact for pricing</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Photo Interface (Initially Hidden) -->
  <div id="photoInterface" class="hidden w-full flex flex-col items-center">
    <div class="w-full max-w-6xl mb-6 flex items-center">
      <button id="changeModeBtn" class="flex items-center gap-2 text-white hover:text-gray-300 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Mode Selection
      </button>
    </div>
    <div class="relative">
      <video id="video" width="640" height="480" autoplay class="rounded-xl shadow-lg"></video>
      <div id="timer" class="timer">3</div>
    </div>
    
    <div class="mt-6 flex gap-4">
      <md-filled-button id="captureBtn" class="!bg-blue-600">Take 4 Photos</md-filled-button>
      <md-filled-button id="qrCodeBtn" class="!bg-purple-600" disabled>Generate QR Code</md-filled-button>
      <md-filled-button id="printBtn" class="!bg-green-600">Print All</md-filled-button>
      <md-filled-button id="resetBtn" class="!bg-red-600">Reset</md-filled-button>
    </div>
    
    <div class="photo-grid mt-8">
      <canvas id="canvas1" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
      <canvas id="canvas2" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
      <canvas id="canvas3" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
      <canvas id="canvas4" width="320" height="240" class="rounded-xl shadow-lg bg-gray-900"></canvas>
    </div>

    <!-- QR Code Container -->
    <div id="qrCodeContainer" class="text-black">
      <h3 class="text-xl font-semibold">Scan to Download Photos</h3>
      <canvas id="qrCode" width="200" height="200"></canvas>
      <a id="downloadLink" href="#" target="_blank">Direct Download Link</a>
    </div>
  </div>

  <script>
    // Mode selection elements
    const modeSelection = document.getElementById('modeSelection');
    const photoInterface = document.getElementById('photoInterface');
    const changeModeBtn = document.getElementById('changeModeBtn');
    let currentMode = null;

    // Function to handle Razorpay payment
    function handlePayment() {
      const options = {
        key: 'rzp_test_1DP5mmOlF5G5ag', // Razorpay test key
        amount: 20000, // Amount in paise (₹200)
        currency: 'INR',
        name: 'Photo Studio',
        description: 'Normal Mode Photo Session',
        image: 'https://via.placeholder.com/128x128.png?text=PS', // Optional logo
        handler: function(response) {
          // Payment successful
          console.log('Payment successful:', response.razorpay_payment_id);
          
          // Create payment record for admin panel
          const paymentInfo = {
            id: response.razorpay_payment_id,
            timestamp: new Date().toISOString(),
            amount: 200,
            mode: 'normal',
            status: 'completed'
          };
          
          // Store payment info in localStorage
          const payments = JSON.parse(localStorage.getItem('photoStudioPayments') || '[]');
          payments.push(paymentInfo);
          localStorage.setItem('photoStudioPayments', JSON.stringify(payments));
          
          // Show photo interface after successful payment
          modeSelection.classList.add('hidden');
          photoInterface.classList.remove('hidden');
          captureBtn.textContent = 'Take 4 Photos';
          document.querySelector('h1').textContent = 'Photo Studio - Normal Mode';
          initializeCamera();
        },
        prefill: {
          name: 'Test User',
          email: 'test@example.com',
          contact: '9999999999'  // Test phone number
        },
        notes: {
          mode: 'Normal Mode',
          session_type: 'Photo Booth'
        },
        theme: {
          color: '#2563eb' // Blue color matching our UI
        }
      };

      const razorpayInstance = new Razorpay(options);
      razorpayInstance.open();
    }

    // Function to handle mode selection
    function selectMode(mode) {
      currentMode = mode;
      
      // Hide admin login button
      document.getElementById('adminLoginBtn').style.display = 'none';
      
      // Configure interface based on selected mode
      if (mode === 'event') {
        // Event mode - direct access
        modeSelection.classList.add('hidden');
        photoInterface.classList.remove('hidden');
        captureBtn.textContent = 'Take Event Photos';
        document.querySelector('h1').textContent = 'Photo Studio - Event Mode';
        initializeCamera();
      } else {
        // Normal mode - show payment first
        handlePayment();
      }
    }

    // Change mode button handler
    changeModeBtn.addEventListener('click', () => {
      // Reset the interface
      resetPhotos();
      
      // Stop the video stream
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      
      // Show mode selection
      photoInterface.classList.add('hidden');
      modeSelection.classList.remove('hidden');
      currentMode = null;
      document.querySelector('h1').textContent = 'Photo Studio';
    });

    const video = document.getElementById('video');
    const timer = document.getElementById('timer');
    const captureBtn = document.getElementById('captureBtn');
    const qrCodeBtn = document.getElementById('qrCodeBtn');
    const printBtn = document.getElementById('printBtn');
    const resetBtn = document.getElementById('resetBtn');
    const canvases = [
      document.getElementById('canvas1'),
      document.getElementById('canvas2'),
      document.getElementById('canvas3'),
      document.getElementById('canvas4')
    ];
    const contexts = canvases.map(canvas => canvas.getContext('2d'));
    let currentPhoto = 0;
    let isCapturing = false;

    // Get camera feed with optimal settings
    const cameraConstraints = {
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: 'user'
      }
    };

    async function initializeCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia(cameraConstraints);
        video.srcObject = stream;
        captureBtn.disabled = false;
      } catch (err) {
        console.error('Camera access error:', err);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'text-red-500 text-center mt-4';
        errorMessage.textContent = 'Camera access denied. Please check your camera permissions.';
        video.parentElement.appendChild(errorMessage);
        captureBtn.disabled = true;
      }
    }

    // Camera will be initialized after mode selection

    // Timer function with visual feedback
    function startTimer(callback) {
      let count = 3;
      timer.style.display = 'block';
      timer.textContent = count;
      timer.className = 'timer animate-pulse';
      
      // Flash effect for countdown
      const flash = () => {
        timer.style.transform = 'translate(-50%, -50%) scale(1.2)';
        setTimeout(() => {
          timer.style.transform = 'translate(-50%, -50%) scale(1)';
        }, 200);
      };
      
      flash();
      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          timer.textContent = count;
          flash();
        } else {
          clearInterval(interval);
          timer.className = 'timer';
          timer.style.display = 'none';
          // Reset transform
          timer.style.transform = 'translate(-50%, -50%)';
          callback();
        }
      }, 1000);

      // Cleanup function in case capture is interrupted
      return () => {
        clearInterval(interval);
        timer.className = 'timer';
        timer.style.display = 'none';
        timer.style.transform = 'translate(-50%, -50%)';
      };
    }

    // Capture sequence
    async function captureSequence() {
      if (isCapturing || currentPhoto >= 4) return;
      
      isCapturing = true;
      captureBtn.disabled = true;
      printBtn.disabled = true;
      
      let cleanupTimer = null;
      
      const capturePhoto = () => {
        // Play capture sound
        const captureSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBkCR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTqL0fPTgjMGHm7A7+OZRA0PVqzn77BdGAg+ltryxnMpBSF6yu7glEILElyx6OyrWBUIQ5zd8sFuJAU3iM/z1oU2Bhxsvv7mlEINDlOq5O+zYBoIPJPY8sp2KwUfdsfv45ZFDBFZr+ftrVoXCECY2/LDcSYFNYXN8diHOQYaa7z85JdGDgxPqOPwtWIdCDqQ1vLNei0FHnHF7+WYRw0PV63l765dGQc9ltnzxXQoBTODy/HaijsHGGi6+uWaSg8LS6Xi8LdlHwg3jdTy0H0vBRxvw+/nmUkODVSs5O+xYBsHOpDY8sd2KgUwgMnx3I09BxZmt/jmoE0QCkij4fC6aCAHNYrS8tOAMQUbbcHu6JtMDwxRqeLwuWMdBzaN1fLLeSsFLn7H8d+PPgcUZLX35KJQEQlGoODwvGohBzKIz/LWhDMFGWu/7eqdTxAKTqPh8LxmIAczi9Py0H4tBS19xvHhkUAIEmGz9+anUxIHQZ3e8L5sJAYwhs3y2IY1BRdovO3snFESCUyh4PC/aSIHMIjQ89OCLwUre8Tx45NCCBBfsfblqVYTBz+b3fDAbCUGLYTL8tuINgUWZrrs7Z5SFAhKn+DwwWwkBi6Gz/PVhDEFKHnC8OWWRAkPXK/15axZFQY8mNvwwm8nBiuByPLdiDgFFWS47O2gVRYISJ3f8MNvJQYshczz2IYzBSZ3wfDnmUYJDVqt9OWuXBcGOpbZ8MRyKAYpf8by34o6BRNituv0pVgXB0Wb3vDFcSYGKoPK89qJOgUXYrXr6ZxLEAdBmN3wzHQpBiZ9xPLhi0AFEWCz6/SmWxkGPpjb8MZ0KQYofsfz3Y0+BRVgsev0qF4ZBj+Y3PDHdyoGJX3E8uKNQQYPXrLq9KleGgY9l9rwynksBiR7xvPgj0MFEl+x6/WrYRsGPZba8Mx6LAYje8Tz4ZFEBg1dsOn1rWMcBjuV2fDNfS4GIXrF8+OSRgYQXK/p9a9lHgY7lNjwzn8vBh96xPPjlEgHDFqv6PawZx8GOZLWpdF/MAYfesPz5ZVKBwpYruj2s2oiBjiS1qnTgjIGHXjC8+eYTAgKVqzn97ZtJAY2kNSm1YQ0Bhx2wfLpmlEJCVOq5vi4cCYGNI3TpteFNgYbdL/y6p1TCwhRqOX4u3MoBjGK0qbYiDgHGXK98euiVgsGT6bk+L53KgYviNCm2os7Bxhwu/HtpVoMBk2k4/i/ei4GLYbPptuOPQcWbrrw7qheDgVKouL4w3wxBiqEzqbdkUAHFW248O+rYRAES6Dh+MZ/MwYngsym35RCBxNruO/wrWUTBEie4PjIgjUGJH/Kpt2WRAkTaLbv8LBpFQNGnN/4zIU3BiJ9yKbemEcJEWa17/CzaxcEQ5rd+M+IOQYgecam4JtKChBjse7xtm4ZA0GY3PjSizwGH3bEpuKdTQoOYK/t8bl0HAM+ldr40o8+Bh10wqbjn1AKDVyu7PK8dx8CPJLYqtWTQQYcc8Cm5aJTCwxZrOvyvXohBDqQ1qrXlUQHGnC+puajVgwKV6rq8sFAJAQ4jdSq2ZhHBxhuvabmpVkNCVSo6fLERCcENYvSqtudSgcWbLum565cDQdRpuny0x0=');
        captureSound.play();
        
        // Flash effect
        const flash = document.createElement('div');
        flash.style.position = 'fixed';
        flash.style.top = '0';
        flash.style.left = '0';
        flash.style.right = '0';
        flash.style.bottom = '0';
        flash.style.backgroundColor = 'white';
        flash.style.opacity = '0';
        flash.style.transition = 'opacity 0.1s';
        document.body.appendChild(flash);
        
        requestAnimationFrame(() => {
          flash.style.opacity = '1';
          setTimeout(() => {
            flash.style.opacity = '0';
            setTimeout(() => flash.remove(), 100);
          }, 50);
        });

        // Capture photo
        contexts[currentPhoto].drawImage(
          video, 
          0, 0, 
          canvases[currentPhoto].width, 
          canvases[currentPhoto].height
        );
        
        currentPhoto++;
        
        // Enable QR code button after first photo
        if (currentPhoto === 1) {
          qrCodeBtn.disabled = false;
        }
        
        if (currentPhoto < 4) {
          cleanupTimer = startTimer(capturePhoto);
        } else {
          isCapturing = false;
          captureBtn.disabled = false;
          printBtn.disabled = false;
          // Enable QR code button after at least one photo
          qrCodeBtn.disabled = false;
        }
      };
      
      cleanupTimer = startTimer(capturePhoto);
      
      // Handle interruption
      resetBtn.onclick = () => {
        if (cleanupTimer) {
          cleanupTimer();
        }
        resetPhotos();
      };
    }

    // Save photos to filesystem and generate unique URL
    async function generatePhotoDownloadURL(photos) {
      const sessionId = Date.now().toString();
      const timestamp = new Date().toISOString();
      const amount = currentMode === 'normal' ? 200 : 0; // ₹200 for normal mode
      
      // Create session directory
      const sessionDir = `generated/${currentMode}/${sessionId}`;
      
      try {
        // Save photos as files
        const photoPromises = photos.map(async (canvas, index) => {
          const photoName = `photo_${index + 1}.jpg`;
          const photoData = canvas.toDataURL('image/jpeg', 0.8);
          
          // Convert base64 to blob
          const response = await fetch(photoData);
          const blob = await response.blob();
          
          // Save file using File System Access API
          try {
            const handle = await window.showSaveFilePicker({
              suggestedName: photoName,
              types: [{
                description: 'JPEG Image',
                accept: {'image/jpeg': ['.jpg']}
              }],
              startIn: sessionDir
            });
            const writable = await handle.createWritable();
            await writable.write(blob);
            await writable.close();
            return photoName;
          } catch (err) {
            console.error('Error saving file:', err);
            throw err;
          }
        });
        
        await Promise.all(photoPromises);
        
        // Create session data for admin panel
        const sessionInfo = {
          id: sessionId,
          timestamp,
          mode: currentMode,
          amount,
          photoCount: photos.length,
          directory: sessionDir
        };
        
        // Add session data to admin panel
        if (window.opener && window.opener.addSessionData) {
          window.opener.addSessionData(sessionInfo);
        }
        
        // Create a URL that includes the session info
        const downloadURL = `${window.location.origin}${window.location.pathname}#session=${sessionId}`;
        return downloadURL;
      } catch (err) {
        console.error('Error saving photos:', err);
        alert('Error saving photos. Please try again.');
        throw err;
      }
    }

    // Generate and display QR code
    function showQRCode() {
      // Check if at least one photo is taken
      const hasPhotos = canvases.some(canvas => {
        try {
          const ctx = canvas.getContext('2d');
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          // Check if the image has any non-black pixels
          for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i] !== 0 || imageData.data[i + 1] !== 0 || imageData.data[i + 2] !== 0) {
              return true;
            }
          }
          return false;
        } catch (error) {
          console.error('Error checking canvas:', error);
          return false;
        }
      });

      if (!hasPhotos) {
        alert('Please take at least one photo before generating QR code!');
        return;
      }

      const qrCodeContainer = document.getElementById('qrCodeContainer');
      const qrCodeCanvas = document.getElementById('qrCode');
      const downloadLink = document.getElementById('downloadLink');
      
      // Generate download URL
      const downloadURL = generatePhotoDownloadURL(canvases);
      
      // Clear previous QR code
      const qrContext = qrCodeCanvas.getContext('2d');
      qrContext.clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
      
      // Generate QR code
      QRCode.toCanvas(qrCodeCanvas, downloadURL, { 
        width: 200,
        margin: 2,
        color: {
          dark: '#000000',
          light: '#ffffff'
        }
      }, (error) => {
        if (error) {
          console.error('Error generating QR code:', error);
          alert('Error generating QR code. Please try again.');
        } else {
          // Update download link
          downloadLink.href = downloadURL;
          
          // Show QR code container
          qrCodeContainer.style.display = 'block';
        }
      });
    }

    // Check for download data in URL and handle photo download
    function checkForDownload() {
      const hash = window.location.hash;
      if (hash.startsWith('#download=')) {
        try {
          const base64Data = hash.replace('#download=', '');
          const jsonStr = atob(base64Data);
          const downloadData = JSON.parse(jsonStr);
          
          // Create download links for each photo
          downloadData.photos.forEach((photo, index) => {
            const link = document.createElement('a');
            link.href = photo.data;
            link.download = photo.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });
          
          // Clear the hash after download
          window.location.hash = '';
        } catch (error) {
          console.error('Error processing download:', error);
          alert('Error downloading photos. Please try again.');
        }
      }
    }

    // Reset all photos
    function resetPhotos() {
      contexts.forEach(ctx => {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      });
      currentPhoto = 0;
      isCapturing = false;
      captureBtn.disabled = false;
      qrCodeBtn.disabled = true; // Disable QR code button when resetting
      
      // Hide QR code container
      document.getElementById('qrCodeContainer').style.display = 'none';
    }

    // Print all photos
    function printPhotos() {
      // Check if there are photos to print
      const hasPhotos = canvases.some(canvas => {
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        return imageData.data.some(pixel => pixel !== 0);
      });

      if (!hasPhotos) {
        alert('Please take some photos before printing!');
        return;
      }

      // Create a hidden print-only container
      const printContainer = document.createElement('div');
      printContainer.className = 'print-only';
      const currentDate = new Date().toLocaleString();
      
      // Add print-specific styles
      const printStyles = document.createElement('style');
      printStyles.textContent = `
        @media screen {
          .print-only {
            display: none;
          }
        }
        @media print {
          /* Hide the main app interface when printing */
          body > *:not(.print-only) {
            display: none !important;
          }
          .print-only {
            display: block;
            margin: 1cm;
          }
          @page {
            size: A4;
            margin: 0;
          }
        }
        .print-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
          margin-bottom: 20px;
        }
        .photo-container {
          aspect-ratio: 4/3;
          background: white;
          border: 1px solid #eee;
          border-radius: 4px;
          overflow: hidden;
        }
        .photo-container img {
          width: 100%;
          height: 100%;
          object-fit: contain;
        }
        .header {
          text-align: center;
          margin-bottom: 20px;
          padding-bottom: 20px;
          border-bottom: 2px solid #eee;
        }
        .timestamp {
          color: #666;
          font-size: 14px;
          margin-top: 5px;
        }
      `;
      document.head.appendChild(printStyles);
      
      // Create the print layout
      printContainer.innerHTML = `
        <div class="header">
          <h1>Photo Studio Prints</h1>
          <div class="timestamp">Printed on ${currentDate}</div>
        </div>
        <div class="print-grid">
          ${canvases.map((canvas, index) => `
            <div class="photo-container">
              <img src="${canvas.toDataURL('image/jpeg', 0.8)}" alt="Photo ${index + 1}">
            </div>
          `).join('')}
        </div>
      `;
      
      // Add the print container to the document
      document.body.appendChild(printContainer);
      
      // Trigger print and clean up afterward
      window.print();
      
      // Remove the print container and styles after printing
      setTimeout(() => {
        document.body.removeChild(printContainer);
        document.head.removeChild(printStyles);
      }, 1000);
    }

    captureBtn.addEventListener('click', captureSequence);
    qrCodeBtn.addEventListener('click', showQRCode);
    printBtn.addEventListener('click', printPhotos);
    resetBtn.addEventListener('click', resetPhotos);

    // Check for downloads when page loads
    window.addEventListener('load', checkForDownload);
    // Check for downloads when hash changes
    window.addEventListener('hashchange', checkForDownload);
  </script>
    </div>
  </body>
</html>
